@page "/register"
@using ExpenseClaimSystem.Application.DTOs
@using ExpenseClaimSystem.Application.Interfaces
@using System.Text.Json
@using System.Net.Http.Json
@inject IAuthService AuthService
@inject NavigationManager Nav
@inject HttpClient Http
@rendermode InteractiveAuto

<h3>Register</h3>

<EditForm Model="model" OnValidSubmit="HandleRegister" FormName="FrmReg">
    <InputText @bind="model.FullName"  @bind-Value="model.FullName" placeholder="Full Name" />
    <br />
    <InputText @bind="model.Email" @bind-Value="model.Email" placeholder="Email" />
    <br />
    <InputText @bind="model.Password" @bind-Value="model.Password" type="password" />
    <br />
    <button type="submit">Register</button>
</EditForm>

@code {
    private RegisterRequest model = new();

    private async Task HandleRegister()
    {
        var result = await Http.PostAsJsonAsync("api/Auth/register", model);

        Console.WriteLine($"response : '{result.IsSuccessStatusCode}'");

        if (result.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/login");
            return;
        }

        // Try to read problem details / error response to show reasons for failure
        try
        {
            var content = await result.Content.ReadFromJsonAsync<JsonElement?>();
            if (content.HasValue)
            {
                Console.WriteLine($"Registration failed response: {content.Value}");
            }
            else
            {
                var text = await result.Content.ReadAsStringAsync();
                Console.WriteLine($"Registration failed response text: {text}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to parse error response: {ex.Message}");
        }
    }
}
