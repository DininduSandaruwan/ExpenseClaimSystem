@page "/claims/list"
@layout MainLayout
@using ExpenseClaimSystem.Application.DTOs
@using ExpenseClaimSystem.Application.Services
@using ExpenseClaimSystem.Domain.Entities
@using ExpenseClaimSystem.Domain.Enums
@using Microsoft.FluentUI.AspNetCore.Components
@rendermode InteractiveServer
@inject IExpenseClaimService ClaimService
@inject NavigationManager Nav


<FluentStack Gap="Spacing.Large" Orientation="Orientation.Vertical">
   @*  <div style="display:flex; justify-content:space-between; align-items:center;">
        <FluentText Typo="Typography.H5">Expense Claims</FluentText>
        <div style="display:flex; gap:8px; align-items:center;">
            <InputText Placeholder="Search by request or employee" @bind-Value="searchText" Style="width:300px;" />
            <FluentButton Appearance="Appearance.Outline" @onclick="LoadClaims">Search</FluentButton>
            <FluentButton Appearance="Appearance.Outline" @onclick="() => { filter = new ExpenseClaimFilterDto(); searchText=null; LoadClaims(); }">Clear</FluentButton>
            <FluentButton @onclick="CreateNew" Style="background:#c81d3f; color:#fff; border-radius:18px; padding:8px 14px;">Create New</FluentButton>
        </div>
    </div> *@

    <!-- Filters compact -->
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; background:#fbfbfc; padding:12px; border-radius:8px; border:1px solid #eef4f4;">
        <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-size:12px; color:#666;">Status</div>
            <select @bind="filter.Status" style="padding:6px; border-radius:4px; border:1px solid #ddd;">
                <option value="">All</option>
                <option>Pending</option>
                <option>Approved</option>
                <option>Rejected</option>
                <option>Deleted</option>
            </select>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-size:12px; color:#666;">Department</div>
            <select @bind="filter.Department" style="padding:6px; border-radius:4px; border:1px solid #ddd;">
                <option value="">All</option>
                <option>HR</option>
                <option>Finance</option>
                <option>IT</option>
                <option>Operations</option>
            </select>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-size:12px; color:#666;">From</div>
            <InputDate @bind-Value="filter.FromDate" />
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
            <div style="font-size:12px; color:#666;">To</div>
            <InputDate @bind-Value="filter.ToDate" />
        </div>

        <div style="margin-left:auto;">
            <FluentButton Appearance="Appearance.Outline" @onclick="LoadClaims">Filter</FluentButton>
        </div>
    </div>

    <!-- Styled table -->
    <div style="margin-top:12px; background:#fff; border-radius:8px; border:1px solid #eef4f4; max-height:620px; overflow:auto; min-width:1100px; max-height:620px;">
        <div style="display:flex; padding:12px 16px; background:#fafafa; font-weight:600; color:#333; position:sticky; top:0; z-index:3;">
            <div style="flex:1">Request No</div>
            <div style="flex:1">Employee</div>
            <div style="flex:1">Department</div>
            <div style="flex:1">Created At</div>
            <div style="width:220px; text-align:center">Status / Actions</div>
        </div>

        @if (claims != null && claims.Count > 0)
        {
            @foreach (var claim in PagedClaims)
            {
                <div style="display:flex; align-items:center; padding:12px 16px; border-top:1px solid #f3f3f3;">
                    <div style="flex:1">@claim.RequestNumber</div>
                    <div style="flex:1">@claim.EmployeeId</div>
                    <div style="flex:1">@claim.Department</div>
                    <div style="flex:1">@claim.CreatedAt.ToString("yyyy-MM-dd")</div>
                    <div style="width:220px; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span style="padding:6px 10px; border-radius:14px; background:@GetStatusColor(claim.Status); color:#fff; font-weight:600;">@claim.Status</span>
                        <FluentButton Appearance="Appearance.Stealth" @onclick="() => ViewClaim(claim)">View</FluentButton>
                        <FluentButton Appearance="Appearance.Outline" @onclick="() => EditClaim(claim.Id)">Edit</FluentButton>
                    </div>
                </div>
            }

            <!-- Pagination controls -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-top:1px solid #f3f3f3; background:#fafafa;">
                <div style="color:#666">Showing @((claims.Count == 0) ? 0 : ((CurrentPage - 1) * PageSize + 1)) - @(((CurrentPage - 1) * PageSize) + PagedClaims.Count()) of @claims.Count</div>
                <div style="display:flex; gap:6px; align-items:center;">
                    <button class="fluent-button" disabled="@(CurrentPage == 1)" @onclick="PrevPage">Prev</button>
                    @for (int p = 1; p <= TotalPages; p++)
                    {
                        <button class="fluent-button" style="@(p == CurrentPage ? "background:#c81d3f;color:#fff;" : "background:transparent;")" @onclick="() => GoToPage(p)">@p</button>
                    }
                    <button class="fluent-button" disabled="@(CurrentPage == TotalPages)" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
        else
        {
            <div style="padding:18px; text-align:center; color:#777;">No claims found</div>
        }
    </div>

    <!-- Modal-like details (kept simple) -->
    @if (selectedClaim != null)
    {
        <div style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:40;">
            <div style="background:#fff; padding:20px; width:720px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <FluentText Typo="Typography.H6">Claim Details</FluentText>
                    <FluentButton Appearance="Appearance.Stealth" @onclick="CloseModal">✕</FluentButton>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><strong>Request No:</strong> @selectedClaim.RequestNumber</div>
                    <div><strong>Created At:</strong> @selectedClaim.CreatedAt</div>
                    <div><strong>Employee:</strong> @selectedClaim.EmployeeId</div>
                    <div><strong>Department:</strong> @selectedClaim.Department</div>
                    <div><strong>Status:</strong> <span style="padding:4px 8px; border-radius:12px; background:@GetStatusColor(selectedClaim.Status); color:#fff;">@selectedClaim.Status</span></div>
                    <div><strong>Total:</strong> @selectedClaim.TotalAmount</div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                    <FluentButton Appearance="Appearance.Outline" @onclick="CloseModal">Close</FluentButton>
                </div>
            </div>
        </div>
    }

</FluentStack>
@code {
    private List<ExpenseClaim> claims = new();
    private ExpenseClaim? selectedClaim;
    private ExpenseClaimFilterDto filter = new();
    private string? searchText;
    private int PageSize { get; } = 10;
    private int CurrentPage { get; set; } = 1;
    private int TotalPages { get; set; } = 1;

    private IEnumerable<ExpenseClaim> PagedClaims => claims.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadClaims();
    }

    async Task LoadClaims()
    {
        var all = await ClaimService.GetFilteredAsync(filter);
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var st = searchText.Trim();
            claims = all.Where(c => (c.RequestNumber ?? string.Empty).Contains(st, StringComparison.OrdinalIgnoreCase)
                                  || (c.EmployeeId ?? string.Empty).Contains(st, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        else
        {
            claims = all.ToList();
        }
        // reset pagination
        CurrentPage = 1;
        TotalPages = Math.Max(1, (int)Math.Ceiling((double)(claims?.Count ?? 0) / PageSize));
    }

    void ViewClaim(ExpenseClaim claim)
    {
        selectedClaim = claim;
    }

    void CloseModal()
    {
        selectedClaim = null;
    }

    void EditClaim(Guid id)
    {
        Nav.NavigateTo($"/claims/edit/{id}");
    }

    void CreateNew()
    {
        Nav.NavigateTo("/claims/create");
    }

    void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
        }
    }

    void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
        }
    }

    void GoToPage(int p)
    {
        if (p >= 1 && p <= TotalPages)
            CurrentPage = p;
    }

    string GetStatusColor(ClaimStatus status)
    {
        return status switch
        {
            ClaimStatus.Approved => "#28a745",
            ClaimStatus.Rejected => "#dc3545",
            ClaimStatus.Pending => "#ff9800",
            ClaimStatus.Paid => "#6c757d",
            _ => "#007bff"
        };
    }

}
