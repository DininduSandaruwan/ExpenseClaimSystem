@page "/claims/list"
@layout MainLayout
@using ExpenseClaimSystem.Application.DTOs
@using ExpenseClaimSystem.Application.Services
@using ExpenseClaimSystem.Domain.Entities
@rendermode InteractiveAuto
@inject IExpenseClaimService ClaimService
@inject NavigationManager Nav


<div class="container-fluid">
	<!-- ============================================================== -->
	<!-- Bread crumb and right sidebar toggle -->
	<!-- ============================================================== -->
	<div class="page-breadcrumb">
		<div class="row">
			<div class="col-5 align-self-center">
			</div>
			<div class="col-7 align-self-center">
				<div class="d-flex align-items-center justify-content-end">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb">
							<li class="breadcrumb-item">
								<a href="#">Claims List</a>
							</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>
	</div>
	<h3 class="mb-4">Expense Claims</h3>

	<div class="card p-3 mb-4">
		<div class="row g-3">

			<div class="col-md-3">
				<label>Status</label>
				<select class="form-select" @bind="filter.Status">
					<option value="">All</option>
					<option>Pending</option>
					<option>Approved</option>
					<option>Rejected</option>
					<option>Deleted</option>
				</select>
			</div>

			<div class="col-md-3">
				<label>Department</label>
				<select class="form-select" @bind="filter.Department">
					<option value="">All</option>
					<option>HR</option>
					<option>Finance</option>
					<option>IT</option>
					<option>Operations</option>
				</select>
			</div>

			<div class="col-md-2">
				<label>From</label>
				<InputDate class="form-control" @bind-Value="filter.FromDate" />
			</div>

			<div class="col-md-2">
				<label>To</label>
				<InputDate class="form-control" @bind-Value="filter.ToDate" />
			</div>

			<div class="col-md-2 d-flex align-items-end">
				<button class="btn btn-primary w-100" @onclick="LoadClaims">
					Filter
				</button>
			</div>

		</div>
	</div>

	<table class="table table-striped table-bordered">
		<thead class="table-dark">
			<tr>
				<th>Request No</th>
				<th>Employee</th>
				<th>Department</th>
				<th>Created At</th>
				<th width="200">Actions</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var claim in claims)
			{
				<tr>
					<td>@claim.RequestNumber</td>
					<td>@claim.EmployeeId</td>
					<td>@claim.Department</td>
					<td>@claim.CreatedAt.ToString("yyyy-MM-dd")</td>
					<td>
						<button class="btn btn-sm btn-info me-1"
								@onclick="() => ViewClaim(claim)">
							View
						</button>

						<button class="btn btn-sm btn-warning me-1"
								@onclick="() => EditClaim(claim.Id)">
							Edit
						</button>
					</td>
				</tr>
			}
		</tbody>
	</table>

	<!-- Bootstrap Modal -->
	@if (selectedClaim != null)
	{
		<div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Claim Details</h5>
						<button class="btn-close" @onclick="CloseModal"></button>
					</div>
					<div class="modal-body">
						<p><strong>Request No:</strong> @selectedClaim.RequestNumber</p>
						<p><strong>Employee:</strong> @selectedClaim.EmployeeId</p>
						<p><strong>Department:</strong> @selectedClaim.Department</p>
						<p><strong>Created At:</strong> @selectedClaim.CreatedAt</p>
						<p><strong>Status:</strong> @selectedClaim.Status</p>
						<p><strong>Total:</strong> @selectedClaim.TotalAmount</p>
					</div>
					<div class="modal-footer">
						<button class="btn btn-secondary" @onclick="CloseModal">Close</button>
					</div>
				</div>
			</div>
		</div>
	}

</div>
@code {
	private List<ExpenseClaim> claims = new();
	private ExpenseClaim? selectedClaim;
	private ExpenseClaimFilterDto filter = new();

	protected override async Task OnInitializedAsync()
	{
		await LoadClaims();
	}

	async Task LoadClaims()
	{
		claims = await ClaimService.GetFilteredAsync(filter);
	}

	void ViewClaim(ExpenseClaim claim)
	{
		selectedClaim = claim;
	}

	void CloseModal()
	{
		selectedClaim = null;
	}

	void EditClaim(Guid id)
	{
		Nav.NavigateTo($"/claims/edit/{id}");
	}


	string GetStatusColor(string status)
	{
		return status switch
		{
			"Approved" => "success",
			"Rejected" => "danger",
			"Pending" => "warning",
			"Deleted" => "secondary",
			_ => "primary"
		};
	}

}
