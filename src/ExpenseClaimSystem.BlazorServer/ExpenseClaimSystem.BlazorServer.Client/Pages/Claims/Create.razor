@page "/claims/create"
@layout MainLayout
@using ExpenseClaimSystem.Application.DTOs
@using ExpenseClaimSystem.Application.Services
@using ExpenseClaimSystem.Domain.Enums
@using Microsoft.FluentUI.AspNetCore.Components
@inject IExpenseClaimService ClaimService
@inject HttpClient Http
@rendermode InteractiveAuto

<FluentStack Gap="Spacing.Medium">
    <FluentText Typo="Typography.H5">Create Expense Claim</FluentText>

    <EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="CreateExpenseClaimForm">
        <DataAnnotationsValidator />

        <FluentStack Gap="Spacing.Small">
            <label>Department</label>
            <InputText @bind-Value="model.Department" />
        </FluentStack>

        <FluentText Typo="Typography.H6">Expense Details</FluentText>
        <FluentStack Orientation="Orientation.Horizontal" Gap="Spacing.Medium" Align="Alignment.Center">
            <!-- Currency -->
            <FluentStack>
                <label>Currency</label>
                <select @bind="SelectedCurrency">
                    <option value="">Select Currency</option>
                    @foreach (var currency in Currencies)
                    {
                        <option value="@currency.Id">@currency.Name</option>
                    }
                </select>
            </FluentStack>

            <!-- Category for new item -->
            <FluentStack>
                <label>Category</label>
                <select @bind="currentItem.Category">
                    <option value="">Select Expense Category</option>
                    @foreach (var category in ExpCategories)
                    {
                        <option value="@category.Name">@category.Name</option>
                    }
                </select>
            </FluentStack>

            <FluentStack>
                <label>Description</label>
                <InputText @bind-Value="currentItem.Description" />
            </FluentStack>

            <FluentStack>
                <label>Amount</label>
                <InputNumber @bind-Value="currentItem.Amount" />
            </FluentStack>

            <div style="align-self:end">
                <FluentButton Appearance="Appearance.Outline" @onclick="AddItem">Add Item</FluentButton>
            </div>
        </FluentStack>

        @if (model.Items != null && model.Items.Count > 0)
        {
            <FluentStack Gap="Spacing.Small">
                @foreach (var item in model.Items)
                {
                    <div style="display:flex; gap:12px; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                        <select @bind="item.Category">
                            <option value="">Select Category</option>
                            @foreach (var category in ExpCategories)
                            {
                                <option value="@category.Name">@category.Name</option>
                            }
                        </select>

                        <InputText placeholder="Description" @bind-Value="item.Description" />
                        <InputNumber @bind-Value="item.Amount" />
                        <InputCheckbox @bind-Value="item.IsGstApplicable" />

                        <FluentButton Appearance="Appearance.Stealth" @onclick="() => RemoveItem(item)">Remove</FluentButton>
                    </div>
                }
            </FluentStack>
        }

        <FluentText Typo="Typography.H6">Attachments</FluentText>
        <select>
            <option value="">Select Attachment Type</option>
            @foreach (var attachement in AttachementTypes)
            {
                <option value="@attachement.Id">@attachement.Name</option>
            }
        </select>

        <InputFile OnChange="HandleFileUpload" />

        <FluentText Typo="Typography.H6">Payment Method Details</FluentText>
        <InputRadioGroup @bind-Value="model.PaymentMethod">
            <label><InputRadio Value="PaymentMethod.Cash" /> Cash</label>
            <label><InputRadio Value="PaymentMethod.Card" /> Card</label>
        </InputRadioGroup>

        @if (model.PaymentMethod == PaymentMethod.Card)
        {
            <FluentStack Gap="Spacing.Small">
                <InputText placeholder="Bank Code" @bind-Value="model.BankNameCode" />
                <InputText placeholder="Account Name" @bind-Value="model.AccountName" />
                <InputText placeholder="Account Number" @bind-Value="model.AccountNumber" />
            </FluentStack>
        }

        <div style="margin-top:12px;">
            <button type="submit">Submit</button>
        </div>

    </EditForm>
</FluentStack>

@code {

	private List<IBrowserFile> uploadedFiles = new();

	private ExpenseItemDto currentItem = new();
	private string SelectedCurrency { get; set; }

	private async Task HandleFileUpload(InputFileChangeEventArgs e)
	{
		// Handle each selected file and send as multipart/form-data to the server
		const long maxFileSize = 10_000_000;
		foreach (var file in e.GetMultipleFiles())
		{
			try
			{
				using var content = new MultipartFormDataContent();
				using var ms = new System.IO.MemoryStream();
				await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
				var bytes = ms.ToArray();
				using var fileContent = new ByteArrayContent(bytes);

				// Set the content type if available
				var contentType = string.IsNullOrWhiteSpace(file.ContentType) ? "application/octet-stream" : file.ContentType;
				fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(contentType);

				// Some servers require explicit ContentDisposition header values with quoted names
				fileContent.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("form-data")
				{
					Name = "\"file\"",
					FileName = "\"" + file.Name + "\""
				};

				// The name "file" should match what the server expects; adjust if needed (e.g., "files")
				content.Add(fileContent, "file", file.Name);

				var response = await Http.PostAsync("api/attachments", content);
				var responseBody = await response.Content.ReadAsStringAsync();

				if (response.IsSuccessStatusCode)
				{
					var result = await response.Content.ReadFromJsonAsync<UploadResult>();
					// TODO: store result.FilePath or result.FileName on your model as needed
					uploadedFiles.Add(file);
				}
				else
				{
					// Log status and server response body to help diagnose BadRequest
					Console.Error.WriteLine($"File upload failed for {file.Name}: {response.StatusCode} - {responseBody}");
				}
			}
			catch (Exception ex)
			{
				Console.Error.WriteLine($"Error uploading file {file.Name}: {ex}");
			}
		}
	}

	public class UploadResult
	{
		public string FileName { get; set; }
		public string FilePath { get; set; }
	}

    CreateExpenseClaimDto model = new();

    async Task AddItem()
    {
        if (model.Items == null)
        {
            model.Items = new List<ExpenseItemDto>();
        }

        model.Items.Add(new ExpenseItemDto
        {
            Category = currentItem.Category,
            Description = currentItem.Description,
            Amount = currentItem.Amount,
            IsGstApplicable = currentItem.IsGstApplicable
        });

        currentItem = new ExpenseItemDto();
        await Task.CompletedTask;
    }

    async Task RemoveItem(ExpenseItemDto item)
    {
        model.Items.Remove(item);
        await Task.CompletedTask;
    }

	async Task HandleSubmit()
	{
		// await Http.PostAsJsonAsync("api/ExpenseClaims", model);

		await ClaimService.CreateAsync(model, "user");

		// Optional: navigate to list page
		// NavigationManager.NavigateTo("/claims");
	}

	private List<Crurency> Currencies = new List<Crurency>
	{
		new Crurency { Id = "LKR", Name = "LKR" },
		new Crurency { Id = "USD", Name = "USD" },
		new Crurency { Id = "MVR", Name = "MVR" }
	};

	public class Crurency
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}

	private List<ExpCategory> ExpCategories = new List<ExpCategory>
	{
		new ExpCategory { Id = "1", Name = "Trnsport" },
		new ExpCategory { Id = "2", Name = "Meals" },
		new ExpCategory { Id = "3", Name = "Utility" }
	};

	public class ExpCategory
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}

	private List<AttachementType> AttachementTypes = new List<AttachementType>
	{
		new AttachementType { Id = "1", Name = "Trnsport Bill" },
		new AttachementType { Id = "2", Name = "Meals Bill" },
		new AttachementType { Id = "3", Name = "Utility Bill" }
	};

	public class AttachementType
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}
}
