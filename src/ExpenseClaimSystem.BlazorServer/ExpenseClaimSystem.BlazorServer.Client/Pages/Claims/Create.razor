@page "/claims/create"
@layout MainLayout
@using ExpenseClaimSystem.Application.DTOs
@using ExpenseClaimSystem.Application.Services
@using ExpenseClaimSystem.Domain.Enums
@inject IExpenseClaimService ClaimService
@inject HttpClient Http
@rendermode InteractiveAuto

<div class="container-fluid">
	<div class="page-breadcrumb">
		<div class="row">
			<div class="col-5 align-self-center">
			</div>
			<div class="col-7 align-self-center">
				<div class="d-flex align-items-center justify-content-end">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb">
							<li class="breadcrumb-item">
								<a href="#">Create Expense Claim</a>
							</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>
	</div>
	<h3>Create Expense Claim</h3>

	<EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="CreateExpenseClaimForm">
		<DataAnnotationsValidator />

		<div>
			<label>Department</label>
			<InputText @bind-Value="model.Department" />
		</div>


		<div>
			<h5>Expense Detils</h5>
			<hr />
			@* Dropdown - Currency *@
			<select class="form-select" @bind="SelectedCurrency">
				<option value="">Select Currency</option>
				@foreach (var currency in Currencies)
				{
					<option value="@currency.Id">@currency.Name</option>
				}
			</select>

			@* Dropdown - Expense Category for new item *@
			<select class="form-select" @bind="currentItem.Category">
				<option value="">Select Expense Category</option>
				@foreach (var category in ExpCategories)
				{
					<option value="@category.Name">@category.Name</option>
				}
			</select>

			<label>Description</label>
			<InputText @bind-Value="currentItem.Description" />

			<label>Amount</label>
			<InputNumber @bind-Value="currentItem.Amount" />

			<button type="button" @onclick="AddItem">Add Item</button>


			@foreach (var item in model.Items)
			{
				<div class="expense-row">
					<select class="form-select" @bind="item.Category">
						<option value="">Select Category</option>
						@foreach (var category in ExpCategories)
						{
							<option value="@category.Name">@category.Name</option>
						}
					</select>

					<InputText placeholder="Description" @bind-Value="item.Description" />
					<InputNumber @bind-Value="item.Amount" />
					<InputCheckbox @bind-Value="item.IsGstApplicable" />

					<button type="button" @onclick="() => RemoveItem(item)">
						Remove
					</button>
				</div>
			}
			<hr />

		</div>

		<div>
			<h5>Attchements</h5>
			<hr />
			@* Dropdown - Attachement Types*@
			<select class="form-select">
				<option value="">Select Attachement Type</option>
				@foreach (var attachement in AttachementTypes)
				{
					<option value="@attachement.Id">@attachement.Name</option>
				}
			</select>
		</div>
		<InputFile OnChange="HandleFileUpload" />

		<div>

			<h5>Payment Method Details</h5>
			<hr />
			<InputRadioGroup @bind-Value="model.PaymentMethod">
				<InputRadio Value="PaymentMethod.Cash" /> Cash
				<InputRadio Value="PaymentMethod.Card" /> Card
			</InputRadioGroup>
		</div>

		@if (model.PaymentMethod == PaymentMethod.Card)
		{
			<div>
				<InputText placeholder="Bank Code" @bind-Value="model.BankNameCode" />
				<InputText placeholder="Account Name" @bind-Value="model.AccountName" />
				<InputText placeholder="Account Number" @bind-Value="model.AccountNumber" />
			</div>
		}

		<button type="submit">Submit</button>
	</EditForm>

</div>

@code {

	private List<IBrowserFile> uploadedFiles = new();

	private ExpenseItemDto currentItem = new();
	private string SelectedCurrency { get; set; }

	private async Task HandleFileUpload(InputFileChangeEventArgs e)
	{
		// Handle each selected file and send as multipart/form-data to the server
		const long maxFileSize = 10_000_000;
		foreach (var file in e.GetMultipleFiles())
		{
			try
			{
				using var content = new MultipartFormDataContent();
				using var ms = new System.IO.MemoryStream();
				await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
				var bytes = ms.ToArray();
				using var fileContent = new ByteArrayContent(bytes);

				// Set the content type if available
				var contentType = string.IsNullOrWhiteSpace(file.ContentType) ? "application/octet-stream" : file.ContentType;
				fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(contentType);

				// Some servers require explicit ContentDisposition header values with quoted names
				fileContent.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("form-data")
				{
					Name = "\"file\"",
					FileName = "\"" + file.Name + "\""
				};

				// The name "file" should match what the server expects; adjust if needed (e.g., "files")
				content.Add(fileContent, "file", file.Name);

				var response = await Http.PostAsync("api/attachments", content);
				var responseBody = await response.Content.ReadAsStringAsync();

				if (response.IsSuccessStatusCode)
				{
					var result = await response.Content.ReadFromJsonAsync<UploadResult>();
					// TODO: store result.FilePath or result.FileName on your model as needed
					uploadedFiles.Add(file);
				}
				else
				{
					// Log status and server response body to help diagnose BadRequest
					Console.Error.WriteLine($"File upload failed for {file.Name}: {response.StatusCode} - {responseBody}");
				}
			}
			catch (Exception ex)
			{
				Console.Error.WriteLine($"Error uploading file {file.Name}: {ex}");
			}
		}
	}

	public class UploadResult
	{
		public string FileName { get; set; }
		public string FilePath { get; set; }
	}

	CreateExpenseClaimDto model = new();

	void AddItem()
	{
		if (model.Items == null)
		{
			model.Items = new List<ExpenseItemDto>();
		}

		model.Items.Add(new ExpenseItemDto
		{
			Category = currentItem.Category,
			Description = currentItem.Description,
			Amount = currentItem.Amount,
			IsGstApplicable = currentItem.IsGstApplicable
		});

		currentItem = new ExpenseItemDto();
	}

	void RemoveItem(ExpenseItemDto item)
	{
		model.Items.Remove(item);
	}

	async Task HandleSubmit()
	{
		// await Http.PostAsJsonAsync("api/ExpenseClaims", model);

		await ClaimService.CreateAsync(model, "user");

		// Optional: navigate to list page
		// NavigationManager.NavigateTo("/claims");
	}

	private List<Crurency> Currencies = new List<Crurency>
	{
		new Crurency { Id = "LKR", Name = "LKR" },
		new Crurency { Id = "USD", Name = "USD" },
		new Crurency { Id = "MVR", Name = "MVR" }
	};

	public class Crurency
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}

	private List<ExpCategory> ExpCategories = new List<ExpCategory>
	{
		new ExpCategory { Id = "1", Name = "Trnsport" },
		new ExpCategory { Id = "2", Name = "Meals" },
		new ExpCategory { Id = "3", Name = "Utility" }
	};

	public class ExpCategory
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}

	private List<AttachementType> AttachementTypes = new List<AttachementType>
	{
		new AttachementType { Id = "1", Name = "Trnsport Bill" },
		new AttachementType { Id = "2", Name = "Meals Bill" },
		new AttachementType { Id = "3", Name = "Utility Bill" }
	};

	public class AttachementType
	{
		public string Id { get; set; }
		public string Name { get; set; }
	}
}
